CREATE TABLE teste2 AS 
SELECT mtbl.gid,
mtbl.pstart, mtbl.pend,
ST_StartPoint(geom) AS lstart,
ST_EndPoint(geom) AS lend,
st_tbl.npnt AS nstart, en_tbl.npnt AS nend
FROM (
	SELECT gid, geom, 
	ST_AsText(ST_StartPoint(geom)) AS pstart,
	ST_AsText(ST_EndPoint(geom)) AS pend
	FROM (
		SELECT gid, (ST_Dump(geom)).geom AS geom
		FROM hidrolinhas
	) AS foo
) AS mtbl
LEFT JOIN (
SELECT ROW_NUMBER() OVER (ORDER BY txtgeom) AS idpnt, txtgeom, npnt
FROM (
	SELECT txtgeom, COUNT(txtgeom) AS npnt FROM (
		SELECT pstart AS txtgeom
		FROM (
			SELECT gid, geom, 
			ST_AsText(ST_StartPoint(geom)) AS pstart,
			ST_AsText(ST_EndPoint(geom)) AS pend
			FROM (
				SELECT gid, (ST_Dump(geom)).geom AS geom
				FROM hidrolinhas
			) AS foo
		) AS ta
		UNION ALL
		SELECT pend AS txtgeom
		FROM (
			SELECT gid, geom, 
			ST_AsText(ST_StartPoint(geom)) AS pstart,
			ST_AsText(ST_EndPoint(geom)) AS pend
			FROM (
				SELECT gid, (ST_Dump(geom)).geom AS geom
				FROM hidrolinhas
			) AS foo
		) AS tb
	) AS tbl
	GROUP BY txtgeom
) AS cntpnt WHERE npnt=1
) AS st_tbl 
ON mtbl.pstart = st_tbl.txtgeom
LEFT JOIN (
	SELECT ROW_NUMBER() OVER (ORDER BY txtgeom) AS idpnt, txtgeom, npnt
	FROM (
	SELECT txtgeom, COUNT(txtgeom) AS npnt FROM (
		SELECT pstart AS txtgeom
		FROM (
			SELECT gid, geom, 
			ST_AsText(ST_StartPoint(geom)) AS pstart,
			ST_AsText(ST_EndPoint(geom)) AS pend
			FROM (
				SELECT gid, (ST_Dump(geom)).geom AS geom
				FROM hidrolinhas
			) AS foo
		) AS ta
		UNION ALL
		SELECT pend AS txtgeom
		FROM (
			SELECT gid, geom, 
			ST_AsText(ST_StartPoint(geom)) AS pstart,
			ST_AsText(ST_EndPoint(geom)) AS pend
			FROM (
				SELECT gid, (ST_Dump(geom)).geom AS geom
				FROM hidrolinhas
			) AS foo
		) AS tb
	) AS tbl
	GROUP BY txtgeom
) AS cntpnt WHERE npnt=1
) AS en_tbl
ON mtbl.pend = en_tbl.txtgeom
--WHERE st_tbl.npnt=1 AND en_tbl.npnt = 1
ORDER BY mtbl.gid
;